
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chipsec.hal.uefi_platform &#8212; CHIPSEC  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="shortcut icon" href="../../../_static/chipsec_favicon.jpg"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CHIPSEC  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">chipsec.hal.uefi_platform</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for chipsec.hal.uefi_platform</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1">#CHIPSEC: Platform Security Assessment Framework</span>
<span class="c1">#Copyright (c) 2010-2020, Intel Corporation</span>
<span class="c1">#</span>
<span class="c1">#This program is free software; you can redistribute it and/or</span>
<span class="c1">#modify it under the terms of the GNU General Public License</span>
<span class="c1">#as published by the Free Software Foundation; Version 2.</span>
<span class="c1">#</span>
<span class="c1">#This program is distributed in the hope that it will be useful,</span>
<span class="c1">#but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#You should have received a copy of the GNU General Public License</span>
<span class="c1">#along with this program; if not, write to the Free Software</span>
<span class="c1">#Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="c1">#</span>
<span class="c1">#Contact information:</span>
<span class="c1">#chipsec@intel.com</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Platform specific UEFI functionality (parsing platform specific EFI NVRAM, capsules, etc.)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>

<span class="kn">from</span> <span class="nn">chipsec</span> <span class="kn">import</span> <span class="n">defines</span>
<span class="kn">from</span> <span class="nn">chipsec.logger</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">chipsec.hal.uefi_common</span> <span class="kn">import</span> <span class="n">bit_set</span><span class="p">,</span> <span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">,</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="p">,</span> <span class="n">op_io_pci_mem</span><span class="p">,</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="p">,</span> <span class="n">EFI_GUID_STR</span><span class="p">,</span> <span class="n">EFI_GUID_SIZE</span>
<span class="kn">from</span> <span class="nn">chipsec.hal.uefi_common</span> <span class="kn">import</span> <span class="n">op_stall</span><span class="p">,</span> <span class="n">op_dispatch</span><span class="p">,</span> <span class="n">op_terminate</span><span class="p">,</span> <span class="n">op_mem_poll</span><span class="p">,</span> <span class="n">op_unknown</span><span class="p">,</span> <span class="n">get_3b_size</span><span class="p">,</span> <span class="n">get_nvar_name</span><span class="p">,</span> <span class="n">op_smbus_execute</span><span class="p">,</span> <span class="n">script_width_formats</span>
<span class="kn">from</span> <span class="nn">chipsec.hal.uefi_common</span> <span class="kn">import</span> <span class="n">S3BOOTSCRIPT_ENTRY</span><span class="p">,</span> <span class="n">MAX_S3_BOOTSCRIPT_ENTRY_LENGTH</span><span class="p">,</span> <span class="n">VARIABLE_STORE_FV_GUID</span><span class="p">,</span> <span class="n">IS_VARIABLE_ATTRIBUTE</span><span class="p">,</span> <span class="n">VARIABLE_DATA</span>
<span class="kn">from</span> <span class="nn">chipsec.hal.uefi_common</span> <span class="kn">import</span> <span class="n">EFI_VARIABLE_BOOTSERVICE_ACCESS</span><span class="p">,</span> <span class="n">EFI_VARIABLE_NON_VOLATILE</span><span class="p">,</span> <span class="n">EFI_VARIABLE_RUNTIME_ACCESS</span>
<span class="kn">from</span> <span class="nn">chipsec.hal.uefi_common</span> <span class="kn">import</span> <span class="n">EFI_VARIABLE_HARDWARE_ERROR_RECORD</span><span class="p">,</span> <span class="n">EFI_VARIABLE_AUTHENTICATED_WRITE_ACCESS</span><span class="p">,</span> <span class="n">EFI_VARIABLE_TIME_BASED_AUTHENTICATED_WRITE_ACCESS</span>
<span class="kn">from</span> <span class="nn">chipsec.hal.uefi_fv</span> <span class="kn">import</span> <span class="n">NextFwVolume</span><span class="p">,</span> <span class="n">NextFwFile</span><span class="p">,</span> <span class="n">EFI_FVB2_ERASE_POLARITY</span><span class="p">,</span> <span class="n">EFI_FV_FILETYPE_RAW</span>

<span class="c1">#################################################################################################</span>
<span class="c1"># Dell PFS support,</span>
<span class="c1"># relied heavily on uefi-firmware-parser (https://github.com/theopolis/uefi-firmware-parser)</span>
<span class="c1">#################################################################################################</span>

<span class="n">PFS_SEC_HDR</span> <span class="o">=</span> <span class="s2">&quot;&lt;16sIIIIIIIIII16s&quot;</span>
<span class="n">PFS_SEC_HDR_SIZE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">PFS_SEC_HDR</span><span class="p">)</span>
<span class="n">U1_GUID</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;59b3e2f6-4e42-41f3-b1f4-446a84bfc6d0&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="PfsFileSection"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.PfsFileSection">[docs]</a><span class="k">class</span> <span class="nc">PfsFileSection</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PFS_SEC_HDR_SIZE</span><span class="p">)</span>
        <span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
            <span class="n">gu1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u3</span><span class="p">,</span> <span class="n">u4</span><span class="p">,</span> <span class="n">u5</span><span class="p">,</span> <span class="n">u6</span><span class="p">,</span> <span class="n">sec_size</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">size2</span><span class="p">,</span> <span class="n">size3</span><span class="p">,</span> <span class="n">gu2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">PFS_SEC_HDR</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="n">PFS_SEC_HDR_SIZE</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">PFS_SEC_HDR_SIZE</span> <span class="o">+</span><span class="n">sec_size</span> <span class="o">+</span><span class="n">size1</span> <span class="o">+</span><span class="n">size2</span> <span class="o">+</span><span class="n">size3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">UUID</span><span class="p">(</span><span class="n">bytes_le</span><span class="o">=</span><span class="n">gu1</span><span class="p">)</span> <span class="o">==</span> <span class="n">U1_GUID</span><span class="p">:</span> <span class="n">data_offset</span> <span class="o">=</span> <span class="mh">0x248</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">PFS_SEC_HDR_SIZE</span> <span class="o">+</span><span class="n">data_offset</span><span class="p">:</span><span class="n">PFS_SEC_HDR_SIZE</span> <span class="o">+</span><span class="n">sec_size</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">PFS_SEC_HDR_SIZE</span> <span class="o">+</span><span class="n">sec_size</span> <span class="o">+</span><span class="n">size1</span> <span class="o">+</span><span class="n">size2</span> <span class="o">+</span><span class="n">size3</span><span class="p">:]</span>

<div class="viewcode-block" id="PfsFileSection.parse"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.PfsFileSection.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span></div></div>

<span class="n">PFS_HDR_SIG</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;PFS.HDR.&quot;</span>
<span class="n">PFS_FTR_SIG</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;PFS.FTR.&quot;</span>
<span class="n">PFS_HDR_STRUC</span> <span class="o">=</span> <span class="s2">&quot;&lt;8sII&quot;</span>
<span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">PFS_HDR_STRUC</span><span class="p">)</span>
<span class="n">PFS_FTR_STRUC</span> <span class="o">=</span> <span class="s2">&quot;&lt;II8s&quot;</span>
<span class="n">PFS_FTR_STRUC_SIZE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">PFS_FTR_STRUC</span><span class="p">)</span>

<div class="viewcode-block" id="PfsFile"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.PfsFile">[docs]</a><span class="k">class</span> <span class="nc">PfsFile</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">concat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concat</span> <span class="o">=</span> <span class="n">concat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span> <span class="n">PFS_FTR_STRUC_SIZE</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hdr_sig</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ver</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
            <span class="n">hdr_sig</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">PFS_HDR_STRUC</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="n">PFS_HDR_STRUC_SIZE</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">PFS_FTR_STRUC_SIZE</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:]))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
            <span class="n">ftr_size</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ftr_sig</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">PFS_FTR_STRUC</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span><span class="n">PFS_FTR_STRUC_SIZE</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr_sig</span> <span class="o">==</span> <span class="n">PFS_HDR_SIG</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ftr_sig</span> <span class="o">==</span> <span class="n">PFS_FTR_SIG</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">ftr_size</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span> <span class="n">PFS_FTR_STRUC_SIZE</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">PFS_HDR_STRUC_SIZE</span><span class="p">:</span><span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">PFS_FTR_STRUC_SIZE</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">PFS_HDR_STRUC_SIZE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">PFS_FTR_STRUC_SIZE</span><span class="p">:]</span>

<div class="viewcode-block" id="PfsFile.parse"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.PfsFile.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pfs_sec</span> <span class="o">=</span> <span class="n">PfsFileSection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">pfs_sec_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">pfs_sec</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
            <span class="n">sec_data</span> <span class="o">=</span> <span class="n">pfs_sec</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sec_data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">PFS_HDR_SIG</span><span class="p">)]</span> <span class="o">==</span> <span class="n">PFS_HDR_SIG</span><span class="p">:</span>
                <span class="n">sec_data</span> <span class="o">=</span> <span class="n">PfsFile</span><span class="p">(</span><span class="n">sec_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pfs_sec_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sec_data</span><span class="p">)</span>
            <span class="n">pfs_sec</span> <span class="o">=</span> <span class="n">PfsFileSection</span><span class="p">(</span><span class="n">pfs_sec</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pfs_sec_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pfs_sec_data</span></div></div>

<div class="viewcode-block" id="ParsePFS"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.ParsePFS">[docs]</a><span class="k">def</span> <span class="nf">ParsePFS</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">pfs_file</span> <span class="o">=</span> <span class="n">PfsFile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pfs_file</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">pfs_file_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">pfs_file</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
        <span class="n">pfs_data</span> <span class="o">=</span> <span class="n">pfs_file</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pfs_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pfs_file_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pfs_data</span><span class="p">)</span>
        <span class="n">pfs_file</span> <span class="o">=</span> <span class="n">PfsFile</span><span class="p">(</span><span class="n">pfs_file</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">pfs_file_data</span><span class="p">,</span> <span class="n">pfs_file</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>

<span class="c1">#################################################################################################3</span>
<span class="c1"># List of supported types of EFI NVRAM format (platform/vendor specific)</span>
<span class="c1">#################################################################################################3</span>

<div class="viewcode-block" id="FWType"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.FWType">[docs]</a><span class="k">class</span> <span class="nc">FWType</span><span class="p">:</span>
    <span class="n">EFI_FW_TYPE_UEFI</span>      <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
    <span class="n">EFI_FW_TYPE_UEFI_AUTH</span> <span class="o">=</span> <span class="s1">&#39;uefi_auth&#39;</span>
<span class="c1">#    EFI_FW_TYPE_WIN       = &#39;win&#39;      # Windows 8 GetFirmwareEnvironmentVariable format</span>
    <span class="n">EFI_FW_TYPE_VSS</span>       <span class="o">=</span> <span class="s1">&#39;vss&#39;</span>       <span class="c1"># NVRAM using format with &#39;$VSS&#39; signature</span>
    <span class="n">EFI_FW_TYPE_VSS_AUTH</span>  <span class="o">=</span> <span class="s1">&#39;vss_auth&#39;</span>  <span class="c1"># NVRAM using format with &#39;$VSS&#39; signature with extra fields</span>
                                        <span class="c1"># See &quot;A Tour Beyond BIOS Implementing UEFI Authenticated</span>
                                        <span class="c1"># Variables in SMM with EDKII&quot;</span>
    <span class="n">EFI_FW_TYPE_VSS2</span>       <span class="o">=</span> <span class="s1">&#39;vss2&#39;</span>
    <span class="n">EFI_FW_TYPE_VSS2_AUTH</span>  <span class="o">=</span> <span class="s1">&#39;vss2_auth&#39;</span>
    <span class="n">EFI_FW_TYPE_VSS_APPLE</span> <span class="o">=</span> <span class="s1">&#39;vss_apple&#39;</span>
    <span class="n">EFI_FW_TYPE_NVAR</span>      <span class="o">=</span> <span class="s1">&#39;nvar&#39;</span>      <span class="c1"># &#39;NVAR&#39; NVRAM format</span>
    <span class="n">EFI_FW_TYPE_EVSA</span>      <span class="o">=</span> <span class="s1">&#39;evsa&#39;</span>      <span class="c1"># &#39;EVSA&#39; NVRAM format</span></div>


<span class="n">fw_types</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">FWType</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">FWType</span><span class="p">,</span> <span class="n">t</span><span class="p">))]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
        <span class="n">fw_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">FWType</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">)</span>


<span class="n">NVRAM_ATTR_RT</span>         <span class="o">=</span> <span class="mi">1</span>
<span class="n">NVRAM_ATTR_DESC_ASCII</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">NVRAM_ATTR_GUID</span>       <span class="o">=</span> <span class="mi">4</span>
<span class="n">NVRAM_ATTR_DATA</span>       <span class="o">=</span> <span class="mi">8</span>
<span class="n">NVRAM_ATTR_EXTHDR</span>     <span class="o">=</span> <span class="mh">0x10</span>
<span class="n">NVRAM_ATTR_AUTHWR</span>     <span class="o">=</span> <span class="mh">0x40</span>
<span class="n">NVRAM_ATTR_HER</span>        <span class="o">=</span> <span class="mh">0x20</span>
<span class="n">NVRAM_ATTR_VLD</span>        <span class="o">=</span> <span class="mh">0x80</span>

<span class="c1">#</span>
<span class="c1"># Known GUIDs of NVRAM stored in EFI firmware volumes, FS files etc. of various firmware implementations</span>
<span class="c1">#</span>
<span class="n">ADDITIONAL_NV_STORE_GUID</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;00504624-8A59-4EEB-BD0F-6B36E96128E0&#39;</span><span class="p">)</span>
<span class="n">NVAR_NVRAM_FS_FILE</span>       <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s2">&quot;CEF5B9A3-476D-497F-9FDC-E98143E0422C&quot;</span><span class="p">)</span>

<span class="n">LENOVO_FS1_GUID</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s2">&quot;16B45DA2-7D70-4AEA-A58D-760E9ECB841D&quot;</span><span class="p">)</span>
<span class="n">LENOVO_FS2_GUID</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s2">&quot;E360BDBA-C3CE-46BE-8F37-B231E5CB9F35&quot;</span><span class="p">)</span>

<span class="n">EFI_PLATFORM_FS_GUIDS</span> <span class="o">=</span> <span class="p">[</span><span class="n">LENOVO_FS1_GUID</span><span class="p">,</span> <span class="n">LENOVO_FS2_GUID</span><span class="p">]</span>
<span class="n">EFI_NVRAM_GUIDS</span>       <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLE_STORE_FV_GUID</span><span class="p">,</span> <span class="n">ADDITIONAL_NV_STORE_GUID</span><span class="p">,</span> <span class="n">NVAR_NVRAM_FS_FILE</span><span class="p">]</span>

<span class="c1">#################################################################################################3</span>
<span class="c1"># This Variable header is defined by UEFI</span>
<span class="c1">#################################################################################################3</span>

<span class="c1">#</span>
<span class="c1"># Variable Store Status</span>
<span class="c1">#</span>
<span class="c1">#typedef enum {</span>
<span class="c1">#  EfiRaw,</span>
<span class="c1">#  EfiValid,</span>
<span class="c1">#  EfiInvalid,</span>
<span class="c1">#  EfiUnknown</span>
<span class="c1"># } VARIABLE_STORE_STATUS;</span>
<span class="n">VARIABLE_STORE_STATUS_RAW</span>     <span class="o">=</span> <span class="mi">0</span>
<span class="n">VARIABLE_STORE_STATUS_VALID</span>   <span class="o">=</span> <span class="mi">1</span>
<span class="n">VARIABLE_STORE_STATUS_INVALID</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">VARIABLE_STORE_STATUS_UNKNOWN</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1">#</span>
<span class="c1"># Variable State flags</span>
<span class="c1">#</span>
<span class="n">VAR_IN_DELETED_TRANSITION</span>     <span class="o">=</span> <span class="mh">0xfe</span>  <span class="c1"># Variable is in obsolete transistion</span>
<span class="n">VAR_DELETED</span>                   <span class="o">=</span> <span class="mh">0xfd</span>  <span class="c1"># Variable is obsolete</span>
<span class="n">VAR_ADDED</span>                     <span class="o">=</span> <span class="mh">0x7f</span>  <span class="c1"># Variable has been completely added</span>
<span class="c1">#IS_VARIABLE_STATE(_c, _Mask)  (BOOLEAN) (((~_c) &amp; (~_Mask)) != 0)</span>
<div class="viewcode-block" id="IS_VARIABLE_STATE"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.IS_VARIABLE_STATE">[docs]</a><span class="k">def</span> <span class="nf">IS_VARIABLE_STATE</span><span class="p">(</span><span class="n">_c</span><span class="p">,</span> <span class="n">_Mask</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span> <span class="p">((</span><span class="o">~</span><span class="n">_c</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="o">~</span><span class="n">_Mask</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span></div>

<span class="c1">#</span>
<span class="c1">#typedef struct {</span>
<span class="c1">#  UINT16    StartId;</span>
<span class="c1">#  UINT8     State;</span>
<span class="c1">#  UINT8     Reserved;</span>
<span class="c1">#  UINT32    Attributes;</span>
<span class="c1">#  UINT32    NameSize;</span>
<span class="c1">#  UINT32    DataSize;</span>
<span class="c1">#  EFI_GUID  VendorGuid;</span>
<span class="c1">#} VARIABLE_HEADER;</span>
<span class="c1">#</span>
<span class="c1">#typedef struct {</span>
<span class="c1">#  UINT32  Data1;</span>
<span class="c1">#  UINT16  Data2;</span>
<span class="c1">#  UINT16  Data3;</span>
<span class="c1">#  UINT8   Data4[8];</span>
<span class="c1">#} EFI_GUID;</span>
<span class="c1">#</span>
<span class="n">UEFI_VARIABLE_HEADER_SIZE</span> <span class="o">=</span> <span class="mi">28</span>
<div class="viewcode-block" id="UEFI_VARIABLE_HEADER"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.UEFI_VARIABLE_HEADER">[docs]</a><span class="k">class</span> <span class="nc">UEFI_VARIABLE_HEADER</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;UEFI_VARIABLE_HEADER&#39;</span><span class="p">,</span> <span class="s1">&#39;StartId State Reserved Attributes NameSize DataSize VendorGuid0 VendorGuid1 VendorGuid2 VendorGuid3&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Header (UEFI)</span>
<span class="s2">-------------</span>
<span class="s2">StartId    : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">State      : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved   : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Attributes : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">NameSize   : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">DataSize   : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">VendorGuid : {{0x</span><span class="si">{:08X}</span><span class="s2">-0x</span><span class="si">{:04X}</span><span class="s2">-0x</span><span class="si">{:04X}</span><span class="s2">-0x</span><span class="si">{:08X}</span><span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">StartId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DataSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VendorGuid0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VendorGuid1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VendorGuid2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VendorGuid3</span> <span class="p">)</span></div>


<span class="n">UEFI_VARIABLE_STORE_HEADER</span> <span class="o">=</span> <span class="s2">&quot;&lt;16sIBBHI&quot;</span>
<span class="n">UEFI_VARIABLE_STORE_HEADER_SIZE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">UEFI_VARIABLE_STORE_HEADER</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">EFI_VARIABLE_HEADER_AUTH = &quot;&lt;HBBI28sIIIHH8s&quot;</span>
<span class="sd">EFI_VARIABLE_HEADER_AUTH_SIZE = struct.calcsize(EFI_VARIABLE_HEADER_AUTH)</span>

<span class="sd">EFI_VARIABLE_HEADER = &quot;&lt;HBBIIIIHH8s&quot;</span>
<span class="sd">EFI_VARIABLE_HEADER_SIZE = struct.calcsize(EFI_VARIABLE_HEADER)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">VARIABLE_STORE_FORMATTED</span> <span class="o">=</span> <span class="mh">0x5a</span>
<span class="n">VARIABLE_STORE_HEALTHY</span>   <span class="o">=</span> <span class="mh">0xfe</span>

<span class="k">def</span> <span class="nf">_getNVstore_EFI</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">efi_type</span> <span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">FvOffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">FvLength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fv</span> <span class="o">=</span> <span class="n">NextFwVolume</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FvOffset</span> <span class="o">+</span><span class="n">FvLength</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Guid</span> <span class="o">==</span> <span class="n">VARIABLE_STORE_FV_GUID</span><span class="p">):</span>
            <span class="n">nvram_start</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">HeaderSize</span>
            <span class="n">StoreGuid0</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">Format</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">R1</span> <span class="o">=</span> \
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">UEFI_VARIABLE_STORE_HEADER</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Image</span><span class="p">[</span><span class="n">nvram_start</span><span class="p">:</span><span class="n">nvram_start</span> <span class="o">+</span> <span class="n">UEFI_VARIABLE_STORE_HEADER_SIZE</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">Format</span> <span class="o">==</span> <span class="n">VARIABLE_STORE_FORMATTED</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">State</span> <span class="o">==</span> <span class="n">VARIABLE_STORE_HEALTHY</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isCorrectVSStype</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Image</span><span class="p">[</span><span class="n">nvram_start</span><span class="p">:],</span> <span class="n">efi_type</span><span class="p">)):</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">nvram_start</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Size</span> <span class="o">-</span> <span class="n">nvram_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="n">fv</span> <span class="o">=</span> <span class="n">NextFwVolume</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span><span class="n">fv</span><span class="o">.</span><span class="n">Size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l</span>

<div class="viewcode-block" id="getNVstore_EFI"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_EFI">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_EFI</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_EFI</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getNVstore_EFI_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_EFI_AUTH">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_EFI_AUTH</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_EFI</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_UEFI"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_UEFI">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_UEFI</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_UEFI_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_UEFI_AUTH">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_UEFI_AUTH</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">)</span></div>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def getEFIvariables_UEFI_Ex( nvram_buf, auth = False ):</span>
<span class="sd">    dof = 0</span>
<span class="sd">    length = len(nvram_buf)</span>
<span class="sd">    storen = 0</span>
<span class="sd">    variables = dict()</span>
<span class="sd">    while ((dof+UEFI_VARIABLE_STORE_HEADER_SIZE) &lt; length):</span>
<span class="sd">        store_start = dof</span>
<span class="sd">        StoreGuid0, StoreGuid1, StoreGuid2, StoreGuid03, Size, Format, State, R0, R1 = \</span>
<span class="sd">            struct.unpack(UEFI_VARIABLE_STORE_HEADER, nvram_buf[dof:dof + UEFI_VARIABLE_STORE_HEADER_SIZE])</span>
<span class="sd">        dof = align(dof + UEFI_VARIABLE_STORE_HEADER_SIZE, 4)</span>
<span class="sd">        if ((Format != VARIABLE_STORE_FORMATTED) or (State != VARIABLE_STORE_HEALTHY)):</span>
<span class="sd">            break</span>
<span class="sd">        if ((store_start + Size) &gt;= length): break</span>
<span class="sd">        while ((dof + EFI_VARIABLE_HEADER_SIZE) &lt;= (store_start + Size)):</span>
<span class="sd">            StartId, State, R0, Attributes, Auth, NameSize, DataSize, VendorGuid0, VendorGuid1, VendorGuid2, VendorGuid3 = \</span>
<span class="sd">                struct.unpack(EFI_VARIABLE_HEADER, nvram_buf[dof:dof+EFI_VARIABLE_HEADER_SIZE]);</span>
<span class="sd">            if (StartId != VARIABLE_DATA): break</span>
<span class="sd">            dof += EFI_VARIABLE_HEADER_SIZE</span>
<span class="sd">            if ((State == 0xff) and (DataSize == 0xffffffff) and (NameSize == 0xffffffff) and (Attributes == 0xffffffff)):</span>
<span class="sd">                NameSize = 0</span>
<span class="sd">                DataSize = 0</span>
<span class="sd">                # just skip variable with empty name and data for now</span>
<span class="sd">            else:</span>
<span class="sd">                guid = guid_str(VendorGuid0, VendorGuid1, VendorGuid2, VendorGuid3)</span>
<span class="sd">                Name = nvram_buf[dof:dof+NameSize]</span>
<span class="sd">                NameStr = unicode(Name, &quot;utf-16-le&quot;).split(&#39;\x00&#39;)[0]</span>
<span class="sd">                VarData = nvram_buf[dof+NameSize:dof+NameSize+DataSize]</span>
<span class="sd">                if NameStr not in variables.keys():</span>
<span class="sd">                    variables[NameStr] = []</span>
<span class="sd">                #                          off, buf,  hdr,  data,    guid, attrs</span>
<span class="sd">                variables[NameStr].append((dof, None, None, VarData, guid, Attributes))</span>
<span class="sd">            dof = align(dof+NameSize+DataSize, 4)</span>
<span class="sd">        dof = store_start + Size</span>
<span class="sd">        storen += 1</span>
<span class="sd">    return variables</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1">##################################################################################################</span>
<span class="c1">#</span>
<span class="c1"># Platform/Vendor Specific EFI NVRAM Parsing Functions</span>
<span class="c1">#</span>
<span class="c1"># For each platform, EFI NVRAM parsing functionality includes:</span>
<span class="c1"># 1. Function to parse EFI variable within NVRAM binary (func_getefivariables)</span>
<span class="c1">#    May define/use platform specific EFI Variable Header</span>
<span class="c1">#    Function arguments:</span>
<span class="c1">#      In : binary buffer (as a string)</span>
<span class="c1">#      Out:</span>
<span class="c1">#        start           - offset in the buffer to the current EFI variable</span>
<span class="c1">#        next_var_offset - offset in the buffer to the next EFI variable</span>
<span class="c1">#        efi_var_buf     - full EFI variable buffer</span>
<span class="c1">#        efi_var_hdr     - EFI variable header object</span>
<span class="c1">#        efi_var_name    - EFI variable name</span>
<span class="c1">#        efi_var_data    - EFI variable data contents</span>
<span class="c1">#        efi_var_guid    - EFI variable GUID</span>
<span class="c1">#        efi_var_attr    - EFI variable attributes</span>
<span class="c1"># 2. [Optional] Function to find EFI NVRAM within arbitrary binary (func_getnvstore)</span>
<span class="c1">#    If this function is not defined, &#39;chipsec_util uefi&#39; searches EFI variables from the beginning of the binary</span>
<span class="c1">#    Function arguments:</span>
<span class="c1">#      In : NVRAM binary buffer (as a string)</span>
<span class="c1">#      Out:</span>
<span class="c1">#        start        - offset of NVRAM     (-1 means NVRAM not found)</span>
<span class="c1">#        size         - size of NVRAM       (-1 means NVRAM is entire binary)</span>
<span class="c1">#        nvram_header - NVRAM header object</span>
<span class="c1">#</span>
<span class="c1">##################################################################################################</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># NVAR format of NVRAM</span>
<span class="c1">#</span>

<div class="viewcode-block" id="EFI_HDR_NVAR1"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.EFI_HDR_NVAR1">[docs]</a><span class="k">class</span> <span class="nc">EFI_HDR_NVAR1</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EFI_HDR_NVAR1&#39;</span><span class="p">,</span> <span class="s1">&#39;StartId TotalSize Reserved1 Reserved2 Reserved3 Attributes State&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Header (NVAR)</span>
<span class="s2">------------</span>
<span class="s2">StartId    : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">TotalSize  : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">Reserved1  : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved2  : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved3  : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Attributes : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">State      : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">StartId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TotalSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span> <span class="p">)</span></div>

<span class="n">NVAR_EFIvar_signature</span>   <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;NVAR&#39;</span>

<div class="viewcode-block" id="getNVstore_NVAR"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_NVAR">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_NVAR</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">fv</span> <span class="o">=</span> <span class="n">NextFwVolume</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">l</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">l</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">fv</span><span class="o">.</span><span class="n">Size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">):</span>
        <span class="n">fv</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">fv</span><span class="o">.</span><span class="n">Offset</span>
    <span class="k">while</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">polarity</span> <span class="o">=</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="n">EFI_FVB2_ERASE_POLARITY</span><span class="p">)</span>
        <span class="n">fwbin</span> <span class="o">=</span> <span class="n">NextFwFile</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">HeaderSize</span><span class="p">,</span> <span class="n">polarity</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">fwbin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fwbin</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">EFI_FV_FILETYPE_RAW</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fwbin</span><span class="o">.</span><span class="n">Guid</span> <span class="o">==</span> <span class="n">NVAR_NVRAM_FS_FILE</span><span class="p">):</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">((</span><span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">fwbin</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">fwbin</span><span class="o">.</span><span class="n">HeaderSize</span><span class="p">),</span> <span class="n">fwbin</span><span class="o">.</span><span class="n">Size</span> <span class="o">-</span> <span class="n">fwbin</span><span class="o">.</span><span class="n">HeaderSize</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fwbin</span><span class="o">.</span><span class="n">UD</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">l</span>
            <span class="n">fwbin</span> <span class="o">=</span> <span class="n">NextFwFile</span><span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">fwbin</span><span class="o">.</span><span class="n">Size</span> <span class="o">+</span><span class="n">fwbin</span><span class="o">.</span><span class="n">Offset</span><span class="p">,</span> <span class="n">polarity</span><span class="p">)</span>
        <span class="n">fv</span> <span class="o">=</span> <span class="n">NextFwVolume</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span><span class="n">fv</span><span class="o">.</span><span class="n">Size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l</span></div>

<span class="k">def</span> <span class="nf">_ord</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span>

<div class="viewcode-block" id="getEFIvariables_NVAR"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_NVAR">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_NVAR</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">NVAR_EFIvar_signature</span> <span class="p">)</span>
    <span class="n">nvram_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="n">EFI_HDR_NVAR</span> <span class="o">=</span> <span class="s2">&quot;&lt;4sH3sB&quot;</span>
    <span class="n">nvar_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">EFI_HDR_NVAR</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">nof</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#start</span>
<span class="c1">#   EMPTY = 0</span>
    <span class="n">EMPTY</span> <span class="o">=</span> <span class="mh">0xffffffff</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">nof</span> <span class="o">+</span><span class="n">nvar_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nvram_size</span><span class="p">:</span>
        <span class="n">start_id</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">EFI_HDR_NVAR</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">nof</span><span class="p">:</span><span class="n">nof</span> <span class="o">+</span><span class="n">nvar_size</span><span class="p">])</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">get_3b_size</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_VLD</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_DATA</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">nof</span> <span class="o">=</span> <span class="n">nof</span> <span class="o">+</span> <span class="n">size</span>
            <span class="k">continue</span>
        <span class="n">isvar</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_id</span> <span class="o">==</span> <span class="n">NVAR_EFIvar_signature</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">isvar</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="p">(</span><span class="n">EMPTY</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)):</span> <span class="k">break</span>
        <span class="n">var_name_off</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_GUID</span><span class="p">):</span>
            <span class="n">guid</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">bytes_le</span><span class="o">=</span><span class="n">nvram_buf</span><span class="p">[</span><span class="n">nof</span> <span class="o">+</span> <span class="n">nvar_size</span><span class="p">:</span> <span class="n">nof</span> <span class="o">+</span> <span class="n">nvar_size</span> <span class="o">+</span> <span class="n">EFI_GUID_SIZE</span><span class="p">])</span>
            <span class="n">guid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">guid</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">var_name_off</span> <span class="o">=</span> <span class="n">EFI_GUID_SIZE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guid_idx</span> <span class="o">=</span> <span class="n">_ord</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">[</span><span class="n">nof</span> <span class="o">+</span><span class="n">nvar_size</span><span class="p">])</span>
            <span class="n">guid_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">nvram_size</span> <span class="o">-</span> <span class="n">EFI_GUID_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="n">guid_idx</span> <span class="o">*</span> <span class="n">EFI_GUID_SIZE</span>
            <span class="n">guid</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="n">bytes_le</span><span class="o">=</span><span class="n">nvram_buf</span><span class="p">[</span><span class="n">guid_off</span><span class="p">:</span> <span class="n">guid_off</span> <span class="o">+</span> <span class="n">EFI_GUID_SIZE</span><span class="p">])</span>
            <span class="n">guid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">guid</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">name_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">name_offset</span> <span class="o">=</span> <span class="n">nof</span> <span class="o">+</span><span class="n">nvar_size</span> <span class="o">+</span><span class="n">var_name_off</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_DATA</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">name_size</span> <span class="o">=</span> <span class="n">get_nvar_name</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">name_offset</span><span class="p">,</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_DESC_ASCII</span><span class="p">))</span>
        <span class="n">esize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eattrs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_EXTHDR</span><span class="p">):</span>
            <span class="n">esize</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">nof</span> <span class="o">+</span><span class="n">size</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">nof</span> <span class="o">+</span><span class="n">size</span><span class="p">])</span>
            <span class="n">eattrs</span> <span class="o">=</span> <span class="n">_ord</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">[</span><span class="n">nof</span> <span class="o">+</span><span class="n">size</span> <span class="o">-</span><span class="n">esize</span><span class="p">])</span>
        <span class="n">attribs</span> <span class="o">=</span> <span class="n">EFI_VARIABLE_BOOTSERVICE_ACCESS</span>
        <span class="n">attribs</span> <span class="o">=</span> <span class="n">attribs</span> <span class="o">|</span> <span class="n">EFI_VARIABLE_NON_VOLATILE</span>
        <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_RT</span><span class="p">):</span>  <span class="n">attribs</span> <span class="o">=</span> <span class="n">attribs</span> <span class="o">|</span> <span class="n">EFI_VARIABLE_RUNTIME_ACCESS</span>
        <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_HER</span><span class="p">):</span> <span class="n">attribs</span> <span class="o">=</span> <span class="n">attribs</span> <span class="o">|</span> <span class="n">EFI_VARIABLE_HARDWARE_ERROR_RECORD</span>
        <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_AUTHWR</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">eattrs</span><span class="p">,</span> <span class="n">EFI_VARIABLE_AUTHENTICATED_WRITE_ACCESS</span><span class="p">):</span>
                <span class="n">attribs</span> <span class="o">=</span> <span class="n">attribs</span> <span class="o">|</span> <span class="n">EFI_VARIABLE_AUTHENTICATED_WRITE_ACCESS</span>
            <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">eattrs</span><span class="p">,</span> <span class="n">EFI_VARIABLE_TIME_BASED_AUTHENTICATED_WRITE_ACCESS</span><span class="p">):</span>
                <span class="n">attribs</span> <span class="o">=</span> <span class="n">attribs</span> <span class="o">|</span> <span class="n">EFI_VARIABLE_TIME_BASED_AUTHENTICATED_WRITE_ACCESS</span>
        <span class="c1"># Get variable data</span>
        <span class="n">lof</span> <span class="o">=</span> <span class="n">nof</span>
        <span class="n">lnext</span> <span class="o">=</span> <span class="nb">next</span>
        <span class="n">lattributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="n">lsize</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">lesize</span> <span class="o">=</span> <span class="n">esize</span>
        <span class="k">while</span> <span class="n">lnext</span> <span class="o">!=</span> <span class="p">(</span><span class="mh">0xFFFFFF</span> <span class="o">&amp;</span> <span class="n">EMPTY</span><span class="p">):</span>
            <span class="n">lof</span> <span class="o">=</span> <span class="n">lof</span> <span class="o">+</span> <span class="n">lnext</span>
            <span class="n">lstart_id</span><span class="p">,</span> <span class="n">lsize</span><span class="p">,</span> <span class="n">lnext</span><span class="p">,</span> <span class="n">lattributes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">EFI_HDR_NVAR</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">lof</span><span class="p">:</span><span class="n">lof</span> <span class="o">+</span><span class="n">nvar_size</span><span class="p">])</span>
            <span class="n">lnext</span> <span class="o">=</span> <span class="n">get_3b_size</span><span class="p">(</span><span class="n">lnext</span><span class="p">)</span>
        <span class="n">dataof</span> <span class="o">=</span> <span class="n">lof</span> <span class="o">+</span> <span class="n">nvar_size</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">lattributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_DATA</span><span class="p">):</span>
            <span class="n">lnameof</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">lattributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_GUID</span><span class="p">):</span> <span class="n">lnameof</span> <span class="o">=</span> <span class="n">EFI_GUID_SIZE</span>
            <span class="n">name_offset</span> <span class="o">=</span> <span class="n">lof</span> <span class="o">+</span><span class="n">nvar_size</span> <span class="o">+</span><span class="n">lnameof</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">name_size</span> <span class="o">=</span> <span class="n">get_nvar_name</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">name_offset</span><span class="p">,</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_DESC_ASCII</span><span class="p">))</span>
            <span class="n">dataof</span> <span class="o">=</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">name_size</span>
        <span class="k">if</span> <span class="n">bit_set</span><span class="p">(</span><span class="n">lattributes</span><span class="p">,</span> <span class="n">NVRAM_ATTR_EXTHDR</span><span class="p">):</span>
            <span class="n">lesize</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">lof</span> <span class="o">+</span><span class="n">lsize</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">lof</span> <span class="o">+</span><span class="n">lsize</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">dataof</span><span class="p">:</span><span class="n">lof</span> <span class="o">+</span><span class="n">lsize</span> <span class="o">-</span><span class="n">lesize</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#                       off, buf,  hdr,  data, guid, attrs</span>
        <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nof</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">attribs</span><span class="p">))</span>
        <span class="n">nof</span> <span class="o">=</span> <span class="n">nof</span> <span class="o">+</span> <span class="n">size</span>
    <span class="k">return</span> <span class="n">variables</span></div>

<span class="n">NVAR_HDR_FMT</span>          <span class="o">=</span> <span class="s1">&#39;=IHBBBBB&#39;</span>
<span class="n">NVAR_HDR_SIZE</span>         <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">NVAR_HDR_FMT</span> <span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Linear/simple NVAR format parsing</span>
<span class="c1">#</span>
<div class="viewcode-block" id="getNVstore_NVAR_simple"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_NVAR_simple">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_NVAR_simple</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">NVAR_EFIvar_signature</span> <span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_NVAR_simple"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_NVAR_simple">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_NVAR_simple</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="n">nvsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="n">hdr_fmt</span> <span class="o">=</span> <span class="n">NVAR_HDR_FMT</span>
    <span class="n">hdr_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">hdr_fmt</span> <span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">NVAR_EFIvar_signature</span> <span class="p">)</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span> <span class="k">return</span> <span class="n">variables</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nvsize</span><span class="p">:</span>
        <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_NVAR1</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">name_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">efi_var_name</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_VARIABLE_ATTRIBUTE</span><span class="p">(</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="n">EFI_VARIABLE_HARDWARE_ERROR_RECORD</span> <span class="p">):</span>
            <span class="n">name_size</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">:</span> <span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="p">)</span>
            <span class="n">efi_var_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">[</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span> <span class="o">+</span> <span class="n">name_size</span> <span class="p">]</span> <span class="p">)</span>

        <span class="n">next_var_offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">TotalSize</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">TotalSize</span> <span class="o">-</span> <span class="n">name_size</span> <span class="o">-</span> <span class="n">hdr_size</span>
        <span class="n">efi_var_buf</span>  <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span> <span class="n">start</span><span class="p">:</span> <span class="n">next_var_offset</span> <span class="p">]</span>
        <span class="n">efi_var_data</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span> <span class="o">+</span> <span class="n">name_size</span><span class="p">:</span> <span class="n">next_var_offset</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">efi_var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">variables</span><span class="p">[</span><span class="n">efi_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#                               off,   buf,         hdr,         data,         guid, attrs</span>
        <span class="n">variables</span><span class="p">[</span><span class="n">efi_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">efi_var_buf</span><span class="p">,</span> <span class="n">efi_var_hdr</span><span class="p">,</span> <span class="n">efi_var_data</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>   <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">Attributes</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">next_var_offset</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">next_var_offset</span>

    <span class="k">return</span> <span class="n">variables</span></div>


<span class="c1">#######################################################################</span>
<span class="c1">#</span>
<span class="c1"># VSS NVRAM (signature = &#39;$VSS&#39;)</span>
<span class="c1">#</span>
<span class="c1">#</span>

<span class="c1">#define VARIABLE_STORE_SIGNATURE  EFI_SIGNATURE_32 (&#39;$&#39;, &#39;V&#39;, &#39;S&#39;, &#39;S&#39;)</span>
<span class="n">VARIABLE_STORE_SIGNATURE_VSS</span>  <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;$VSS&#39;</span>
<span class="n">VARIABLE_STORE_HEADER_FMT_VSS</span> <span class="o">=</span> <span class="s1">&#39;=IIBBHI&#39;</span> <span class="c1"># Signature is &#39;$VSS&#39;</span>
<div class="viewcode-block" id="VARIABLE_STORE_HEADER_VSS"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.VARIABLE_STORE_HEADER_VSS">[docs]</a><span class="k">class</span> <span class="nc">VARIABLE_STORE_HEADER_VSS</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;VARIABLE_STORE_HEADER_VSS&#39;</span><span class="p">,</span> <span class="s1">&#39;Signature Size Format State Reserved Reserved1&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">EFI Variable Store</span>
<span class="s2">-----------------------------</span>
<span class="s2">Signature : </span><span class="si">{}</span><span class="s2"> (0x</span><span class="si">{:08X}</span><span class="s2">)</span>
<span class="s2">Size      : 0x</span><span class="si">{:08X}</span><span class="s2"> bytes</span>
<span class="s2">Format    : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">State     : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved  : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">Reserved1 : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;=I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Signature</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Signature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved1</span> <span class="p">)</span></div>

<span class="n">VARIABLE_STORE_SIGNATURE_VSS2</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;DDCF3617-3275-4164-98B6-FE85707FFE7D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bytes_le</span>
<span class="n">VARIABLE_STORE_SIGNATURE_VSS2_AUTH</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;AAF32C78-947B-439A-A180-2E144EC37792&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bytes_le</span>

<span class="n">VARIABLE_STORE_HEADER_FMT_VSS2</span> <span class="o">=</span> <span class="s1">&#39;=16sIBBHI&#39;</span>
<div class="viewcode-block" id="VARIABLE_STORE_HEADER_VSS2"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.VARIABLE_STORE_HEADER_VSS2">[docs]</a><span class="k">class</span> <span class="nc">VARIABLE_STORE_HEADER_VSS2</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;VARIABLE_STORE_HEADER_VSS2&#39;</span><span class="p">,</span> <span class="s1">&#39;Signature Size Format State Reserved Reserved1&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">EFI Variable Store</span>
<span class="s2">-----------------------------</span>
<span class="s2">Signature : </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">Size      : 0x</span><span class="si">%08X</span><span class="s2"> bytes</span>
<span class="s2">Format    : 0x</span><span class="si">%02X</span><span class="s2"></span>
<span class="s2">State     : 0x</span><span class="si">%02X</span><span class="s2"></span>
<span class="s2">Reserved  : 0x</span><span class="si">%04X</span><span class="s2"></span>
<span class="s2">Reserved1 : 0x</span><span class="si">%08X</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">UUID</span><span class="p">(</span><span class="n">bytes_le</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Signature</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved1</span> <span class="p">)</span></div>

<span class="n">VARIABLE_STORE_SIGNATURE_VSS2</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;DDCF3617-3275-4164-98B6-FE85707FFE7D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bytes_le</span>
<span class="n">VARIABLE_STORE_SIGNATURE_VSS2_AUTH</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;AAF32C78-947B-439A-A180-2E144EC37792&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bytes_le</span>

<span class="n">HDR_FMT_VSS</span>                   <span class="o">=</span> <span class="s1">&#39;&lt;HBBIII16s&#39;</span>
<span class="c1">#HDR_SIZE_VSS                  = struct.calcsize( HDR_FMT_VSS )</span>
<span class="c1">#NAME_OFFSET_IN_VAR_VSS        = HDR_SIZE_VSS</span>
<div class="viewcode-block" id="EFI_HDR_VSS"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.EFI_HDR_VSS">[docs]</a><span class="k">class</span> <span class="nc">EFI_HDR_VSS</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EFI_HDR_VSS&#39;</span><span class="p">,</span> <span class="s1">&#39;StartId State Reserved Attributes NameSize DataSize guid&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Header (VSS)</span>
<span class="s2">------------</span>
<span class="s2">VendorGuid : {{</span><span class="si">{}</span><span class="s2">}}</span>
<span class="s2">StartId    : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">State      : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved   : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Attributes : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">NameSize   : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">DataSize   : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">EFI_GUID_STR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">StartId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DataSize</span><span class="p">)</span></div>


<span class="n">HDR_FMT_VSS_AUTH</span>  <span class="o">=</span> <span class="s1">&#39;&lt;HBBIQQQIII16s&#39;</span>
<div class="viewcode-block" id="EFI_HDR_VSS_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.EFI_HDR_VSS_AUTH">[docs]</a><span class="k">class</span> <span class="nc">EFI_HDR_VSS_AUTH</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EFI_HDR_VSS_AUTH&#39;</span><span class="p">,</span> <span class="s1">&#39;StartId State Reserved Attributes MonotonicCount TimeStamp1 TimeStamp2 PubKeyIndex NameSize DataSize guid&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1"># if you don&#39;t re-define __str__ method, initialize is to None</span>
    <span class="c1">#__str__ = None</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Header (VSS_AUTH)</span>
<span class="s2">----------------</span>
<span class="s2">VendorGuid     : {{</span><span class="si">{}</span><span class="s2">}}</span>
<span class="s2">StartId        : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">State          : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved       : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Attributes     : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">MonotonicCount : 0x</span><span class="si">{:016X}</span><span class="s2"></span>
<span class="s2">TimeStamp1     : 0x</span><span class="si">{:016X}</span><span class="s2"></span>
<span class="s2">TimeStamp2     : 0x</span><span class="si">{:016X}</span><span class="s2"></span>
<span class="s2">PubKeyIndex    : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">NameSize       : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">DataSize       : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">EFI_GUID_STR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">StartId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MonotonicCount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimeStamp1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TimeStamp2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PubKeyIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DataSize</span> <span class="p">)</span></div>

<span class="n">HDR_FMT_VSS_APPLE</span>  <span class="o">=</span> <span class="s1">&#39;&lt;HBBIII16sI&#39;</span>
<div class="viewcode-block" id="EFI_HDR_VSS_APPLE"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.EFI_HDR_VSS_APPLE">[docs]</a><span class="k">class</span> <span class="nc">EFI_HDR_VSS_APPLE</span><span class="p">(</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EFI_HDR_VSS_APPLE&#39;</span><span class="p">,</span> <span class="s1">&#39;StartId State Reserved Attributes NameSize DataSize guid unknown&#39;</span><span class="p">)</span> <span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Header (VSS_APPLE)</span>
<span class="s2">------------</span>
<span class="s2">VendorGuid : {{</span><span class="si">{}</span><span class="s2">}}</span>
<span class="s2">StartId    : 0x</span><span class="si">{:04X}</span><span class="s2"></span>
<span class="s2">State      : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Reserved   : 0x</span><span class="si">{:02X}</span><span class="s2"></span>
<span class="s2">Attributes : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">NameSize   : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">DataSize   : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">Unknown    : 0x</span><span class="si">{:08X}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">EFI_GUID_STR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">StartId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reserved</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Attributes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DataSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_getNVstore_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">vss_type</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">vss_type</span> <span class="o">==</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">VARIABLE_STORE_SIGNATURE_VSS2</span>
    <span class="k">elif</span> <span class="n">vss_type</span> <span class="o">==</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">VARIABLE_STORE_SIGNATURE_VSS2_AUTH</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">VARIABLE_STORE_SIGNATURE_VSS</span>

    <span class="n">nvram_start</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">sign</span> <span class="p">)</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">nvram_start</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">nvram_start</span><span class="p">:]</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">isCorrectVSStype</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">vss_type</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vss_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">):</span>
        <span class="n">nvram_hdr</span> <span class="o">=</span> <span class="n">VARIABLE_STORE_HEADER_VSS2</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">VARIABLE_STORE_HEADER_FMT_VSS2</span><span class="p">,</span> <span class="n">buf</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nvram_hdr</span> <span class="o">=</span> <span class="n">VARIABLE_STORE_HEADER_VSS</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">VARIABLE_STORE_HEADER_FMT_VSS</span><span class="p">,</span> <span class="n">buf</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nvram_start</span><span class="p">,</span> <span class="n">nvram_hdr</span><span class="o">.</span><span class="n">Size</span><span class="p">,</span> <span class="n">nvram_hdr</span><span class="p">)</span>

<div class="viewcode-block" id="getNVstore_VSS"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_VSS">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">)</span></div>

<div class="viewcode-block" id="getNVstore_VSS_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_VSS_AUTH">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_VSS_AUTH</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">)</span></div>

<div class="viewcode-block" id="getNVstore_VSS2"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_VSS2">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_VSS2</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">)</span></div>

<div class="viewcode-block" id="getNVstore_VSS2_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_VSS2_AUTH">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_VSS2_AUTH</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">)</span></div>

<div class="viewcode-block" id="getNVstore_VSS_APPLE"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_VSS_APPLE">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_VSS_APPLE</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_getNVstore_VSS</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span><span class="p">)</span></div>

<span class="n">VSS_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span><span class="p">)</span>
<span class="n">MAX_VSS_VAR_ALIGNMENT</span> <span class="o">=</span> <span class="mi">8</span>

<div class="viewcode-block" id="isCorrectVSStype"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.isCorrectVSStype">[docs]</a><span class="k">def</span> <span class="nf">isCorrectVSStype</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">vss_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vss_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VSS_TYPES</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">buf_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="n">start</span>    <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_SIGNATURE_VSS</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">next_var</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">HDR_FMT_VSS</span> <span class="p">)</span> <span class="p">)</span> <span class="c1"># skip the minimun bytes required for the header</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">next_var</span><span class="p">):</span>
        <span class="n">next_var</span> <span class="o">=</span> <span class="n">buf_size</span>

    <span class="n">buf_size</span> <span class="o">-=</span> <span class="n">start</span>

    <span class="k">if</span>   <span class="p">(</span><span class="n">vss_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">)):</span>
        <span class="n">hdr_fmt</span>  <span class="o">=</span> <span class="n">HDR_FMT_VSS</span>
        <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_VSS</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">vss_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">)):</span>
        <span class="n">hdr_fmt</span>  <span class="o">=</span> <span class="n">HDR_FMT_VSS_AUTH</span>
        <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_VSS_AUTH</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">vss_type</span> <span class="o">==</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span><span class="p">):</span>
        <span class="n">hdr_fmt</span>  <span class="o">=</span> <span class="n">HDR_FMT_VSS_APPLE</span>
        <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_VSS_APPLE</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">hdr_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">hdr_fmt</span> <span class="p">)</span>
    <span class="c1"># check NameSize and DataSize</span>
    <span class="n">name_offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">name_offset</span> <span class="o">&lt;</span> <span class="n">next_var</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">name_offset</span> <span class="o">+</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">NameSize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">next_var</span><span class="p">)):</span>
        <span class="n">valid_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">NameSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">name_offset</span><span class="p">:</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">NameSize</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-16-le&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valid_name</span> <span class="o">=</span> <span class="n">defines</span><span class="o">.</span><span class="n">is_printable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">valid_name</span><span class="p">):</span>
            <span class="n">end_var_offset</span> <span class="o">=</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">NameSize</span> <span class="o">+</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">DataSize</span>
            <span class="n">off_diff</span> <span class="o">=</span> <span class="n">next_var</span> <span class="o">-</span> <span class="n">end_var_offset</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">off_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">off_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">next_var</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">off_diff</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_VSS_VAR_ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">next_var</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)):</span>
                    <span class="n">new_nex_var</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">,</span> <span class="n">next_var</span><span class="p">,</span> <span class="n">next_var</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_VSS_VAR_ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">new_nex_var</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>

<span class="k">def</span> <span class="nf">_getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">_fwtype</span><span class="p">):</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">nvsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_fwtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">):</span>
        <span class="n">hdr_fmt</span>  <span class="o">=</span> <span class="n">HDR_FMT_VSS</span>
    <span class="k">elif</span> <span class="n">_fwtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">):</span>
        <span class="n">hdr_fmt</span>  <span class="o">=</span> <span class="n">HDR_FMT_VSS_AUTH</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span> <span class="o">==</span> <span class="n">_fwtype</span><span class="p">):</span>
        <span class="n">hdr_fmt</span>  <span class="o">=</span> <span class="n">HDR_FMT_VSS_APPLE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">variables</span>
    <span class="n">hdr_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">hdr_fmt</span> <span class="p">)</span>
    <span class="n">start</span>    <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_SIGNATURE_VSS</span> <span class="p">)</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">variables</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nvsize</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_fwtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">):</span>
            <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_VSS</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">_fwtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">):</span>
            <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_VSS_AUTH</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span> <span class="o">==</span> <span class="n">_fwtype</span><span class="p">):</span>
            <span class="n">efi_var_hdr</span> <span class="o">=</span> <span class="n">EFI_HDR_VSS_APPLE</span><span class="p">(</span> <span class="o">*</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span> <span class="n">hdr_fmt</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">StartId</span> <span class="o">!=</span> <span class="n">VARIABLE_DATA</span><span class="p">):</span> <span class="k">break</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">State</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">DataSize</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">NameSize</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">Attributes</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)):</span>
            <span class="n">name_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># just skip variable with empty name and data for now</span>
            <span class="n">next_var_offset</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_VSS_VAR_ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">next_var_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">next_var_offset</span> <span class="o">&gt;</span> <span class="n">nvsize</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_size</span> <span class="o">=</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">NameSize</span>
            <span class="n">data_size</span> <span class="o">=</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">DataSize</span>
            <span class="n">efi_var_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;not defined&gt;&quot;</span>

            <span class="n">end_var_offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">hdr_size</span> <span class="o">+</span> <span class="n">name_size</span> <span class="o">+</span> <span class="n">data_size</span>
            <span class="n">efi_var_buf</span>  <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span> <span class="n">start</span><span class="p">:</span> <span class="n">end_var_offset</span> <span class="p">]</span>

            <span class="n">name_offset</span> <span class="o">=</span> <span class="n">hdr_size</span>
            <span class="n">Name</span> <span class="o">=</span> <span class="n">efi_var_buf</span><span class="p">[</span> <span class="n">name_offset</span><span class="p">:</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">name_size</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">Name</span><span class="p">:</span>
                <span class="n">efi_var_name</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-16-le&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">efi_var_data</span> <span class="o">=</span> <span class="n">efi_var_buf</span><span class="p">[</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">name_size</span><span class="p">:</span> <span class="n">name_offset</span> <span class="o">+</span> <span class="n">name_size</span> <span class="o">+</span> <span class="n">data_size</span> <span class="p">]</span>
            <span class="n">guid</span> <span class="o">=</span> <span class="n">EFI_GUID_STR</span><span class="p">(</span><span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">guid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">efi_var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">efi_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#                                off,   buf,         hdr,         data,         guid, attrs</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">efi_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">efi_var_buf</span><span class="p">,</span> <span class="n">efi_var_hdr</span><span class="p">,</span> <span class="n">efi_var_data</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="n">efi_var_hdr</span><span class="o">.</span><span class="n">Attributes</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># deal with different alignments (1-8)</span>
            <span class="n">next_var_offset</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">,</span> <span class="n">end_var_offset</span><span class="p">,</span> <span class="n">end_var_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">VARIABLE_SIGNATURE_VSS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">MAX_VSS_VAR_ALIGNMENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">next_var_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">next_var_offset</span> <span class="o">&gt;</span> <span class="n">nvsize</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">next_var_offset</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">next_var_offset</span>

    <span class="k">return</span> <span class="n">variables</span>


<div class="viewcode-block" id="getEFIvariables_VSS"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_VSS">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_VSS_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_VSS_AUTH">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_VSS_AUTH</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_VSS2"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_VSS2">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_VSS2</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_VSS2_AUTH"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_VSS2_AUTH">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_VSS2_AUTH</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span> <span class="p">)</span></div>

<div class="viewcode-block" id="getEFIvariables_VSS_APPLE"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getEFIvariables_VSS_APPLE">[docs]</a><span class="k">def</span> <span class="nf">getEFIvariables_VSS_APPLE</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="k">return</span> <span class="n">_getEFIvariables_VSS</span><span class="p">(</span> <span class="n">nvram_buf</span><span class="p">,</span> <span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span> <span class="p">)</span></div>

<span class="c1">#######################################################################</span>
<span class="c1">#</span>
<span class="c1"># EVSA NVRAM (signature = &#39;EVSA&#39;)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="n">VARIABLE_STORE_SIGNATURE_EVSA</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;EVSA&#39;</span>

<span class="n">TLV_HEADER</span> <span class="o">=</span> <span class="s2">&quot;&lt;BBH&quot;</span>
<span class="n">tlv_h_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">TLV_HEADER</span><span class="p">)</span>

<div class="viewcode-block" id="getNVstore_EVSA"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.getNVstore_EVSA">[docs]</a><span class="k">def</span> <span class="nf">getNVstore_EVSA</span><span class="p">(</span> <span class="n">nvram_buf</span> <span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">fv</span> <span class="o">=</span> <span class="n">NextFwVolume</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">fv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Guid</span> <span class="o">==</span> <span class="n">VARIABLE_STORE_FV_GUID</span><span class="p">):</span>
            <span class="n">nvram_start</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_STORE_SIGNATURE_EVSA</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nvram_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nvram_start</span> <span class="o">&gt;=</span> <span class="n">tlv_h_size</span><span class="p">):</span>
                <span class="n">nvram_start</span> <span class="o">=</span> <span class="n">nvram_start</span> <span class="o">-</span> <span class="n">tlv_h_size</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">nvram_start</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Size</span> <span class="o">-</span> <span class="n">nvram_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Guid</span> <span class="o">==</span> <span class="n">ADDITIONAL_NV_STORE_GUID</span><span class="p">):</span>
            <span class="n">nvram_start</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">VARIABLE_STORE_SIGNATURE_EVSA</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nvram_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nvram_start</span> <span class="o">&gt;=</span> <span class="n">tlv_h_size</span><span class="p">):</span>
                <span class="n">nvram_start</span> <span class="o">=</span> <span class="n">nvram_start</span> <span class="o">-</span> <span class="n">tlv_h_size</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">nvram_start</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Size</span> <span class="o">-</span> <span class="n">nvram_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">fv</span> <span class="o">=</span> <span class="n">NextFwVolume</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">,</span> <span class="n">fv</span><span class="o">.</span><span class="n">Offset</span> <span class="o">+</span><span class="n">fv</span><span class="o">.</span><span class="n">Size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l</span></div>

<div class="viewcode-block" id="EFIvar_EVSA"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.EFIvar_EVSA">[docs]</a><span class="k">def</span> <span class="nf">EFIvar_EVSA</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">):</span>
    <span class="n">image_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nvram_buf</span><span class="p">)</span>
    <span class="n">sn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">EVSA_RECORD</span> <span class="o">=</span> <span class="s2">&quot;&lt;IIII&quot;</span>
    <span class="n">evsa_rec_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">EVSA_RECORD</span><span class="p">)</span>
    <span class="n">GUID_RECORD</span> <span class="o">=</span> <span class="s2">&quot;&lt;H16s&quot;</span>
    <span class="n">guid_rc_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">GUID_RECORD</span><span class="p">)</span>
    <span class="n">fof</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">fof</span> <span class="o">&lt;</span> <span class="n">image_size</span><span class="p">:</span>
        <span class="n">fof</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">VARIABLE_STORE_SIGNATURE_EVSA</span><span class="p">,</span> <span class="n">fof</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fof</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">fof</span> <span class="o">&lt;</span> <span class="n">tlv_h_size</span><span class="p">:</span>
            <span class="n">fof</span> <span class="o">=</span> <span class="n">fof</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="k">continue</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">fof</span> <span class="o">-</span> <span class="n">tlv_h_size</span>
        <span class="n">Tag0</span><span class="p">,</span> <span class="n">Tag1</span><span class="p">,</span> <span class="n">Size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">TLV_HEADER</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">tlv_h_size</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Tag0</span> <span class="o">!=</span> <span class="mh">0xEC</span><span class="p">:</span> <span class="c1"># Wrong EVSA block</span>
            <span class="n">fof</span> <span class="o">=</span> <span class="n">fof</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="k">continue</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">tlv_h_size</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">Size</span><span class="p">]</span>
        <span class="n">Signature</span><span class="p">,</span> <span class="n">Unkwn0</span><span class="p">,</span> <span class="n">Length</span><span class="p">,</span> <span class="n">Unkwn1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">EVSA_RECORD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">+</span> <span class="n">Length</span> <span class="o">&gt;</span> <span class="n">image_size</span><span class="p">:</span> <span class="c1"># Wrong EVSA record</span>
            <span class="n">fof</span> <span class="o">=</span> <span class="n">fof</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="k">continue</span>
        <span class="c1"># NV storage EVSA found</span>
        <span class="n">bof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">guid_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">var_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">value_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">bof</span> <span class="o">+</span> <span class="n">tlv_h_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Length</span><span class="p">:</span>
            <span class="n">Tag0</span><span class="p">,</span> <span class="n">Tag1</span><span class="p">,</span> <span class="n">Size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">TLV_HEADER</span><span class="p">,</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">bof</span><span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">bof</span> <span class="o">+</span> <span class="n">tlv_h_size</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Size</span> <span class="o">&lt;</span> <span class="n">tlv_h_size</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">nvram_buf</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">bof</span> <span class="o">+</span> <span class="n">tlv_h_size</span><span class="p">:</span><span class="n">start</span> <span class="o">+</span> <span class="n">bof</span> <span class="o">+</span> <span class="n">Size</span><span class="p">]</span>
            <span class="n">bof</span> <span class="o">=</span> <span class="n">bof</span> <span class="o">+</span> <span class="n">Size</span>
            <span class="k">if</span>   <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xED</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xE1</span><span class="p">):</span>  <span class="c1"># guid</span>
                <span class="n">GuidId</span><span class="p">,</span> <span class="n">guid0</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">GUID_RECORD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">EFI_GUID_STR</span><span class="p">(</span><span class="n">guid0</span><span class="p">)</span>
                <span class="n">guid_map</span><span class="p">[</span><span class="n">GuidId</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xEE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xE2</span><span class="p">):</span>  <span class="c1"># var name</span>
                <span class="n">VAR_NAME_RECORD</span> <span class="o">=</span> <span class="s2">&quot;&lt;H</span><span class="si">{:d}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Size</span> <span class="o">-</span> <span class="n">tlv_h_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">VarId</span><span class="p">,</span> <span class="n">Name</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">VAR_NAME_RECORD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">Name</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-16-le&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">var_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Name</span><span class="p">,</span> <span class="n">VarId</span><span class="p">,</span> <span class="n">Tag0</span><span class="p">,</span> <span class="n">Tag1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xEF</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xE3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0x83</span><span class="p">):</span>  <span class="c1"># values</span>
                <span class="n">VAR_VALUE_RECORD</span> <span class="o">=</span> <span class="s2">&quot;&lt;HHI</span><span class="si">{:d}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Size</span> <span class="o">-</span> <span class="n">tlv_h_size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">GuidId</span><span class="p">,</span> <span class="n">VarId</span><span class="p">,</span> <span class="n">Attributes</span><span class="p">,</span> <span class="n">Data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">VAR_VALUE_RECORD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">value_list</span><span class="p">[</span><span class="n">VarId</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">GuidId</span><span class="p">,</span> <span class="n">Attributes</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">Tag0</span><span class="p">,</span> <span class="n">Tag1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">((</span><span class="n">Tag0</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Tag1</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)):</span>
                <span class="k">pass</span>
        <span class="n">var_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_list</span><span class="p">)</span>
        <span class="n">var_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">var1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">VarId</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#NameTag0 = i[2]</span>
            <span class="c1">#NameTag1 = i[3]</span>
            <span class="k">if</span> <span class="n">VarId</span> <span class="ow">in</span> <span class="n">value_list</span><span class="p">:</span>
                <span class="n">var_value</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="n">VarId</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#  Value not found for VarId</span>
                <span class="k">continue</span>
            <span class="n">GuidId</span> <span class="o">=</span> <span class="n">var_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">guid</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
            <span class="k">if</span> <span class="n">GuidId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guid_map</span><span class="p">:</span>
                <span class="c1"># Guid not found for GuidId</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guid</span> <span class="o">=</span> <span class="n">guid_map</span><span class="p">[</span><span class="n">GuidId</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#                       off,   buf,  hdr,  data,         guid, attrs</span>
            <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">var_value</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">guid</span><span class="p">,</span> <span class="n">var_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">fof</span> <span class="o">=</span> <span class="n">fof</span> <span class="o">+</span> <span class="n">Length</span>
    <span class="k">return</span> <span class="n">variables</span></div>



<span class="c1">#</span>
<span class="c1"># Uncomment if you want to parse output buffer returned by NtEnumerateSystemEnvironmentValuesEx</span>
<span class="c1"># using &#39;chipsec_util uefi nvram&#39; command</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Windows 8 NtEnumerateSystemEnvironmentValuesEx (infcls = 2)</span>
<span class="c1">#</span>
<span class="c1">#def guid_str(guid0, guid1, guid2, guid3):</span>
<span class="c1">#        return ( &quot;{:08X}-{:04X}-{:04X}-{:4}-{:6}&quot;.format(guid0, guid1, guid2, guid3[:2].encode(&#39;hex&#39;).upper(), guid3[-6::].encode(&#39;hex&#39;).upper()) )</span>
<span class="c1">#</span>
<span class="c1">#class EFI_HDR_WIN( namedtuple(&#39;EFI_HDR_WIN&#39;, &#39;Size DataOffset DataSize Attributes guid0 guid1 guid2 guid3&#39;) ):</span>
<span class="c1">#        __slots__ = ()</span>
<span class="c1">#        def __str__(self):</span>
<span class="c1">#            return &quot;&quot;&quot;</span>
<span class="c1">#Header (Windows)</span>
<span class="c1">#----------------</span>
<span class="c1">#VendorGuid= {{:08X}-{:04X}-{:04X}-{:4}-{:6}}</span>
<span class="c1">#Size      = 0x{:08X}</span>
<span class="c1">#DataOffset= 0x{:08X}</span>
<span class="c1">#DataSize  = 0x{:08X}</span>
<span class="c1">#Attributes= 0x{:08X}</span>
<span class="c1">#&quot;&quot;&quot;.format( self.guid0, self.guid1, self.guid2, self.guid3[:2].encode(&#39;hex&#39;).upper(), self.guid3[-6::].encode(&#39;hex&#39;).upper(), self.Size, self.DataOffset, self.DataSize, self.Attributes )</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">def getEFIvariables_NtEnumerateSystemEnvironmentValuesEx2( nvram_buf ):</span>
<span class="sd">        start = 0</span>
<span class="sd">        buffer = nvram_buf</span>
<span class="sd">        bsize = len(buffer)</span>
<span class="sd">        header_fmt = &quot;&lt;IIIIIHH8s&quot;</span>
<span class="sd">        header_size = struct.calcsize( header_fmt )</span>
<span class="sd">        variables = dict()</span>
<span class="sd">        off = 0</span>
<span class="sd">        while (off + header_size) &lt; bsize:</span>
<span class="sd">           efi_var_hdr = EFI_HDR_WIN( *struct.unpack_from( header_fmt, buffer[ off : off + header_size ] ) )</span>

<span class="sd">           next_var_offset = off + efi_var_hdr.Size</span>
<span class="sd">           efi_var_buf     = buffer[ off : next_var_offset ]</span>
<span class="sd">           efi_var_data    = buffer[ off + efi_var_hdr.DataOffset : off + efi_var_hdr.DataOffset + efi_var_hdr.DataSize ]</span>

<span class="sd">           #efi_var_name = &quot;&quot;.join( buffer[ start + header_size : start + efi_var_hdr.DataOffset ] ).decode(&#39;utf-16-le&#39;)</span>
<span class="sd">           str_fmt = &quot;{:d}s&quot;.format(efi_var_hdr.DataOffset - header_size)</span>
<span class="sd">           s, = struct.unpack( str_fmt, buffer[ off + header_size : off + efi_var_hdr.DataOffset ] )</span>
<span class="sd">           efi_var_name = unicode(s, &quot;utf-16-le&quot;, errors=&quot;replace&quot;).split(u&#39;\u0000&#39;)[0]</span>

<span class="sd">           if efi_var_name not in variables.keys():</span>
<span class="sd">               variables[efi_var_name] = []</span>
<span class="sd">           #                                off, buf,         hdr,         data,         guid,                                                                                 attrs</span>
<span class="sd">           variables[efi_var_name].append( (off, efi_var_buf, efi_var_hdr, efi_var_data, guid_str(efi_var_hdr.guid0, efi_var_hdr.guid1, efi_var_hdr.guid2, efi_var_hdr.guid3), efi_var_hdr.Attributes) )</span>

<span class="sd">           if 0 == efi_var_hdr.Size: break</span>
<span class="sd">           off = next_var_offset</span>

<span class="sd">        return variables</span>
<span class="sd">#    return ( start, next_var_offset, efi_var_buf, efi_var_hdr, efi_var_name, efi_var_data, guid_str(efi_var_hdr.guid0, efi_var_hdr.guid1, efi_var_hdr.guid2, efi_var_hdr.guid3), efi_var_hdr.Attributes )</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1">#################################################################################################3</span>
<span class="c1"># Decoding S3 Resume Boot Script</span>
<span class="c1">#################################################################################################3</span>

<div class="viewcode-block" id="S3BootScriptType"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.S3BootScriptType">[docs]</a><span class="k">class</span> <span class="nc">S3BootScriptType</span><span class="p">:</span>
    <span class="n">EFI_BOOT_SCRIPT_TYPE_DEFAULT</span>   <span class="o">=</span> <span class="mh">0x00</span>
    <span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span> <span class="o">=</span> <span class="mh">0xAA</span></div>


<div class="viewcode-block" id="decode_s3bs_opcode"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.decode_s3bs_opcode">[docs]</a><span class="k">def</span> <span class="nf">decode_s3bs_opcode</span><span class="p">(</span> <span class="n">s3bootscript_type</span><span class="p">,</span> <span class="n">script_data</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span> <span class="o">==</span> <span class="n">s3bootscript_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decode_s3bs_opcode_edkcompat</span><span class="p">(</span> <span class="n">script_data</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decode_s3bs_opcode_def</span><span class="p">(</span> <span class="n">script_data</span> <span class="p">)</span></div>

<div class="viewcode-block" id="encode_s3bs_opcode"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.encode_s3bs_opcode">[docs]</a><span class="k">def</span> <span class="nf">encode_s3bs_opcode</span><span class="p">(</span> <span class="n">s3bootscript_type</span><span class="p">,</span> <span class="n">op</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span> <span class="o">==</span> <span class="n">s3bootscript_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">encode_s3bs_opcode_edkcompat</span><span class="p">(</span> <span class="n">op</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">encode_s3bs_opcode_def</span><span class="p">(</span> <span class="n">op</span> <span class="p">)</span></div>


<div class="viewcode-block" id="decode_s3bs_opcode_def"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.decode_s3bs_opcode_def">[docs]</a><span class="k">def</span> <span class="nf">decode_s3bs_opcode_def</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
    <span class="n">opcode</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">size</span>    <span class="o">=</span> <span class="kc">None</span>
    <span class="n">width</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unknown</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">count</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mask</span>    <span class="o">=</span> <span class="kc">None</span>

    <span class="n">op</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">opcode</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">script_opcodes</span><span class="p">[</span><span class="n">opcode</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="n">size</span><span class="p">:</span> <span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="n">size</span><span class="p">:</span> <span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="n">size</span><span class="p">:</span> <span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">unknown</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_SMBUS_EXECUTE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBQBB&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">peccheck</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_smbus_execute</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">peccheck</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_STALL_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_stall</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">duration</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_DISPATCH_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">dummy1</span><span class="p">,</span> <span class="n">dummy2</span><span class="p">,</span> <span class="n">dummy3</span><span class="p">,</span> <span class="n">entrypoint</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_dispatch</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">entrypoint</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_DISPATCH_2_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="n">dummy1</span><span class="p">,</span> <span class="n">dummy2</span><span class="p">,</span> <span class="n">dummy3</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_dispatch</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">context</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TERMINATE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;B&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">opcode</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_terminate</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_unknown</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;Unrecognized opcode </span><span class="si">{:X}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">op</span></div>

<span class="c1">#</span>
<span class="c1"># @TODO: encode functions are not fully implemented</span>
<span class="c1">#</span>
<div class="viewcode-block" id="encode_s3bs_opcode_def"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.encode_s3bs_opcode_def">[docs]</a><span class="k">def</span> <span class="nf">encode_s3bs_opcode_def</span><span class="p">(</span> <span class="n">op</span> <span class="p">):</span>
    <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_hdr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;BBHIQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">count</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">encoded_hdr</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">buffer</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">encoded_hdr</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>  <span class="n">script_width_formats</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">]</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">op</span><span class="o">.</span><span class="n">values</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">mask</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_WRITE_OPCODE</span>        <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_hdr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">unknown</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">count</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">encoded_hdr</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">buffer</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">encoded_hdr</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>  <span class="n">script_width_formats</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">]</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">op</span><span class="o">.</span><span class="n">values</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBHIQQQ&#39;</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;BBHIQQQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">unknown</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">mask</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_SMBUS_EXECUTE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBQBB&#39;</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_STALL_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;BBQ&#39;</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_DISPATCH_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;BBHIQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">entrypoint</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_DISPATCH_2_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;BBHIQQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">context</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TERMINATE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;B&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;Unrecognized opcode </span><span class="si">{:X}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">encoded_opcode</span></div>


<div class="viewcode-block" id="decode_s3bs_opcode_edkcompat"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.decode_s3bs_opcode_edkcompat">[docs]</a><span class="k">def</span> <span class="nf">decode_s3bs_opcode_edkcompat</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
    <span class="n">opcode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">width</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">count</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mask</span>   <span class="o">=</span> <span class="kc">None</span>

    <span class="n">op</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">hdr_frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;HB&#39;</span>
    <span class="n">header_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">hdr_frmt</span> <span class="p">)</span>
    <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">hdr_frmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span> <span class="p">:</span> <span class="n">header_size</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">opcode_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span> <span class="n">header_size</span><span class="p">:</span> <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">script_opcodes</span><span class="p">[</span><span class="n">opcode</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span>   <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_WRITE_OPCODE</span>                <span class="o">==</span> <span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_WRITE_OPCODE</span>        <span class="o">==</span> <span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_WRITE_OPCODE</span>               <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>

        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;IIQ&#39;</span>
        <span class="n">op_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="p">:</span> <span class="n">op_size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="n">op_size</span><span class="p">:</span> <span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_READ_WRITE_OPCODE</span>         <span class="o">==</span> <span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_READ_WRITE_OPCODE</span>        <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;IQ&#39;</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="p">:</span> <span class="n">sz</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span><span class="n">script_width_formats</span><span class="p">[</span><span class="n">width</span><span class="p">]</span>
        <span class="n">op_size</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="n">sz</span><span class="p">:</span> <span class="n">op_size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_io_pci_mem</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_SMBUS_EXECUTE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">UTIL_TRACE</span> <span class="ow">or</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;Cannot parse opcode </span><span class="si">{:X}</span><span class="s1"> yet&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_STALL_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q&#39;</span>
        <span class="n">op_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">duration</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="p">:</span> <span class="n">op_size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_stall</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">duration</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_DISPATCH_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q&#39;</span>
        <span class="n">op_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">entrypoint</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="p">:</span> <span class="n">op_size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_dispatch</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">entrypoint</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_POLL_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;IQQQ&#39;</span>
        <span class="n">op_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span> <span class="n">frmt</span> <span class="p">)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">looptimes</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">opcode_data</span><span class="p">[</span> <span class="p">:</span> <span class="n">op_size</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_mem_poll</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">looptimes</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TERMINATE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_terminate</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span> <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">op_unknown</span><span class="p">(</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">size</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;Unrecognized opcode </span><span class="si">{:X}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">op</span></div>

<span class="c1">#</span>
<span class="c1"># @TODO: encode functions are not fully implemented</span>
<span class="c1">#</span>
<div class="viewcode-block" id="encode_s3bs_opcode_edkcompat"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.encode_s3bs_opcode_edkcompat">[docs]</a><span class="k">def</span> <span class="nf">encode_s3bs_opcode_edkcompat</span><span class="p">(</span> <span class="n">op</span> <span class="p">):</span>
    <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span>   <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_WRITE_OPCODE</span>         <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_WRITE_OPCODE</span>        <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>

        <span class="n">encoded_hdr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;IIQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">encoded_hdr</span> <span class="o">+</span> <span class="n">op</span><span class="o">.</span><span class="n">buffer</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">encoded_hdr</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>  <span class="n">script_width_formats</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">]</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">op</span><span class="o">.</span><span class="n">values</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_IO_READ_WRITE_OPCODE</span>         <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_PCI_CONFIG_READ_WRITE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span> <span class="ow">or</span> \
         <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_READ_WRITE_OPCODE</span>        <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>

        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;IQ2</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_width_formats</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">])</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="n">frmt</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">mask</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_SMBUS_EXECUTE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_STALL_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s1">&#39;&lt;Q&#39;</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_DISPATCH_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">entrypoint</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_MEM_POLL_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="n">encoded_opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;IQQQ&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">looptimes</span> <span class="p">)</span>

    <span class="k">elif</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TERMINATE_OPCODE</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">encoded_opcode</span></div>



<div class="viewcode-block" id="parse_s3bootscript_entry"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.parse_s3bootscript_entry">[docs]</a><span class="k">def</span> <span class="nf">parse_s3bootscript_entry</span><span class="p">(</span> <span class="n">s3bootscript_type</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">log_script</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="n">entry_index</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entry_length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opcode</span>       <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entry_data</span>   <span class="o">=</span> <span class="kc">None</span>

    <span class="n">remaining_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">script</span><span class="p">[</span><span class="n">off</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span> <span class="o">==</span> <span class="n">s3bootscript_type</span><span class="p">:</span>
        <span class="n">fhdr</span> <span class="o">=</span> <span class="s1">&#39;&lt;HB&#39;</span>
        <span class="n">hdr_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fhdr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remaining_len</span> <span class="o">&lt;</span> <span class="n">hdr_length</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;the script should have at least 0x</span><span class="si">{:X}</span><span class="s1"> bytes to parse next entry&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr_length</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">opcode</span><span class="p">,</span> <span class="n">entry_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span> <span class="n">fhdr</span><span class="p">,</span> <span class="n">script</span><span class="p">[</span> <span class="n">off</span><span class="p">:</span> <span class="n">off</span> <span class="o">+</span> <span class="n">hdr_length</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TERMINATE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
            <span class="n">entry_length</span> <span class="o">=</span> <span class="n">hdr_length</span>
        <span class="n">entry_data</span> <span class="o">=</span> <span class="n">script</span><span class="p">[</span> <span class="n">off</span><span class="p">:</span> <span class="n">off</span> <span class="o">+</span> <span class="n">entry_length</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">entry_length</span> <span class="o">&gt;</span> <span class="n">MAX_S3_BOOTSCRIPT_ENTRY_LENGTH</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s1">&#39;[uefi] Unrecognized S3 boot script format (entry length = 0x</span><span class="si">{:X}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_length</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">s3script_entry</span> <span class="o">=</span> <span class="n">S3BOOTSCRIPT_ENTRY</span><span class="p">(</span> <span class="n">s3bootscript_type</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">entry_length</span><span class="p">,</span> <span class="n">entry_data</span> <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># S3BootScriptType.EFI_BOOT_SCRIPT_TYPE_DEFAULT</span>

        <span class="n">fhdr</span>       <span class="o">=</span> <span class="s1">&#39;&lt;II&#39;</span>
        <span class="n">hdr_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fhdr</span><span class="p">)</span>
        <span class="n">f</span>          <span class="o">=</span> <span class="n">fhdr</span> <span class="o">+</span> <span class="s1">&#39;B&#39;</span>
        <span class="k">if</span> <span class="n">remaining_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">hdr_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;the script should have at least 0x</span><span class="si">{:X}</span><span class="s1"> bytes to parse next entry&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdr_length</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">entry_index</span><span class="p">,</span> <span class="n">entry_length</span><span class="p">,</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">script</span><span class="p">[</span> <span class="n">off</span><span class="p">:</span> <span class="n">off</span> <span class="o">+</span> <span class="n">hdr_length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">])</span>
        <span class="k">if</span> <span class="n">S3BootScriptOpcode_MDE</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TERMINATE_OPCODE</span> <span class="o">==</span> <span class="n">opcode</span><span class="p">:</span>
            <span class="n">entry_length</span> <span class="o">=</span> <span class="n">hdr_length</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">entry_index</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">entry_data</span> <span class="o">=</span> <span class="n">script</span><span class="p">[</span> <span class="n">off</span> <span class="o">+</span> <span class="n">hdr_length</span><span class="p">:</span> <span class="n">off</span> <span class="o">+</span> <span class="n">entry_length</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">entry_length</span> <span class="o">&gt;</span> <span class="n">MAX_S3_BOOTSCRIPT_ENTRY_LENGTH</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="s1">&#39;[uefi] Unrecognized S3 boot script format (entry length = 0x</span><span class="si">{:X}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_length</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">s3script_entry</span>                <span class="o">=</span> <span class="n">S3BOOTSCRIPT_ENTRY</span><span class="p">(</span> <span class="n">s3bootscript_type</span><span class="p">,</span> <span class="n">entry_index</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">entry_length</span><span class="p">,</span> <span class="n">entry_data</span> <span class="p">)</span>
        <span class="n">s3script_entry</span><span class="o">.</span><span class="n">header_length</span>  <span class="o">=</span> <span class="n">hdr_length</span>

    <span class="n">s3script_entry</span><span class="o">.</span><span class="n">decoded_opcode</span> <span class="o">=</span> <span class="n">decode_s3bs_opcode</span><span class="p">(</span> <span class="n">s3bootscript_type</span><span class="p">,</span> <span class="n">s3script_entry</span><span class="o">.</span><span class="n">data</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">log_script</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">s3script_entry</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">s3script_entry</span><span class="p">)</span></div>


<div class="viewcode-block" id="encode_s3bootscript_entry"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.encode_s3bootscript_entry">[docs]</a><span class="k">def</span> <span class="nf">encode_s3bootscript_entry</span><span class="p">(</span> <span class="n">entry</span> <span class="p">):</span>
    <span class="k">if</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span> <span class="o">==</span> <span class="n">entry</span><span class="o">.</span><span class="n">script_type</span><span class="p">:</span>
        <span class="n">entry_hdr_buf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;HB&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">decoded_opcode</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">length</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># S3BootScriptType.EFI_BOOT_SCRIPT_TYPE_DEFAULT</span>
        <span class="n">entry_hdr_buf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;II&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">length</span> <span class="p">)</span>

    <span class="n">entry_val_buf</span> <span class="o">=</span> <span class="n">encode_s3bs_opcode</span><span class="p">(</span> <span class="n">entry</span><span class="o">.</span><span class="n">script_type</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">decoded_opcode</span> <span class="p">)</span>
    <span class="n">entry_buf</span>     <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">entry_val_buf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entry_buf</span> <span class="o">=</span> <span class="n">entry_hdr_buf</span> <span class="o">+</span> <span class="n">entry_val_buf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s1">&#39;Could not encode opcode of boot script entry (type 0x</span><span class="si">{:X}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">script_type</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">entry_buf</span></div>


<div class="viewcode-block" id="create_s3bootscript_entry_buffer"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.create_s3bootscript_entry_buffer">[docs]</a><span class="k">def</span> <span class="nf">create_s3bootscript_entry_buffer</span><span class="p">(</span> <span class="n">script_type</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
    <span class="n">entry_val_buf</span> <span class="o">=</span> <span class="n">encode_s3bs_opcode</span><span class="p">(</span> <span class="n">script_type</span><span class="p">,</span> <span class="n">op</span> <span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry_val_buf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span> <span class="o">==</span> <span class="n">script_type</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s1">&#39;&lt;HB&#39;</span><span class="p">)</span>
        <span class="n">entry_hdr_buf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;HB&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">length</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># S3BootScriptType.EFI_BOOT_SCRIPT_TYPE_DEFAULT</span>
        <span class="n">length</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s1">&#39;&lt;II&#39;</span><span class="p">)</span>
        <span class="n">entry_hdr_buf</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span> <span class="s1">&#39;&lt;II&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">length</span> <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">entry_hdr_buf</span> <span class="o">+</span> <span class="n">entry_val_buf</span><span class="p">)</span></div>


<div class="viewcode-block" id="id_s3bootscript_type"><a class="viewcode-back" href="../../../modules/chipsec.hal.uefi_platform.html#chipsec.hal.uefi_platform.id_s3bootscript_type">[docs]</a><span class="k">def</span> <span class="nf">id_s3bootscript_type</span><span class="p">(</span> <span class="n">script</span><span class="p">,</span> <span class="n">log_script</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="n">script_header_length</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">start_op</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="n">script</span><span class="p">[</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">])</span>
    <span class="k">if</span> <span class="n">S3BootScriptOpcode_EdkCompat</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TABLE_OPCODE</span> <span class="o">==</span> <span class="n">start_op</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;S3 Boot Script AA Parser&#39;</span><span class="p">)</span>
        <span class="n">script_type</span> <span class="o">=</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_EDKCOMPAT</span>
        <span class="k">if</span> <span class="n">log_script</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="s1">&#39;[uefi] Start opcode 0x</span><span class="si">{:X}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_op</span><span class="p">)</span> <span class="p">)</span>
        <span class="c1"># MdeModulePkg\Library\PiDxeS3BootScriptLib\BootScriptInternalFormat.h</span>
        <span class="n">script_header_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;&lt;HBHLHH&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">HAL</span><span class="p">:</span> <span class="n">logger</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;S3 Boot Script DEFAULT Parser&#39;</span><span class="p">)</span>
        <span class="n">script_type</span> <span class="o">=</span> <span class="n">S3BootScriptType</span><span class="o">.</span><span class="n">EFI_BOOT_SCRIPT_TYPE_DEFAULT</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">script_type</span><span class="p">,</span> <span class="n">script_header_length</span><span class="p">)</span></div>



<span class="c1">#################################################################################################3</span>
<span class="c1"># EFI Variable Header Dictionary</span>
<span class="c1">#################################################################################################3</span>

<span class="c1">#</span>
<span class="c1"># Add your EFI variable details to the dictionary</span>
<span class="c1">#</span>
<span class="c1"># Fields:</span>
<span class="c1"># name          func_getefivariables            func_getnvstore</span>
<span class="c1">#</span>
<span class="n">EFI_VAR_DICT</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1"># UEFI</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_UEFI</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;UEFI&#39;</span><span class="p">,</span>      <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_UEFI</span><span class="p">,</span>      <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_EFI</span>  <span class="p">},</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_UEFI_AUTH</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;UEFI_AUTH&#39;</span><span class="p">,</span> <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_UEFI_AUTH</span><span class="p">,</span> <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_EFI_AUTH</span>  <span class="p">},</span>
<span class="c1"># Windows 8 NtEnumerateSystemEnvironmentValuesEx (infcls = 2)</span>
<span class="c1">#FWType.EFI_FW_TYPE_WIN     : {&#39;name&#39; : &#39;WIN&#39;,     &#39;func_getefivariables&#39; : getEFIvariables_NtEnumerateSystemEnvironmentValuesEx2, &#39;func_getnvstore&#39; : None },</span>
<span class="c1"># NVAR format</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_NVAR</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;NVAR&#39;</span><span class="p">,</span>      <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_NVAR</span><span class="p">,</span>      <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_NVAR</span> <span class="p">},</span>
<span class="c1"># $VSS NVRAM format</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VSS&#39;</span><span class="p">,</span>       <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_VSS</span><span class="p">,</span>       <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_VSS</span> <span class="p">},</span>
<span class="c1"># $VSS Authenticated NVRAM format</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_AUTH</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VSS_AUTH&#39;</span><span class="p">,</span>  <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_VSS_AUTH</span><span class="p">,</span>  <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_VSS_AUTH</span> <span class="p">},</span>
<span class="c1"># VSS2 NVRAM format</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VSS2&#39;</span><span class="p">,</span>       <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_VSS2</span><span class="p">,</span>       <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_VSS2</span> <span class="p">},</span>
<span class="c1"># VSS2 Authenticated NVRAM format</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS2_AUTH</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VSS2_AUTH&#39;</span><span class="p">,</span>  <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_VSS2_AUTH</span><span class="p">,</span>  <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_VSS2_AUTH</span> <span class="p">},</span>
<span class="c1"># Apple $VSS formart</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_VSS_APPLE</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VSS_APPLE&#39;</span><span class="p">,</span> <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">getEFIvariables_VSS_APPLE</span><span class="p">,</span> <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_VSS_APPLE</span> <span class="p">},</span>
<span class="c1"># EVSA</span>
<span class="n">FWType</span><span class="o">.</span><span class="n">EFI_FW_TYPE_EVSA</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;EVSA&#39;</span><span class="p">,</span>      <span class="s1">&#39;func_getefivariables&#39;</span><span class="p">:</span> <span class="n">EFIvar_EVSA</span><span class="p">,</span>               <span class="s1">&#39;func_getnvstore&#39;</span><span class="p">:</span> <span class="n">getNVstore_EVSA</span> <span class="p">},</span>
<span class="p">}</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/chipsec_logo_transparent.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<p class="caption"><span class="caption-text">Start here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Download.html">Download CHIPSEC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Contact.html">Contact</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Install%20in%20Windows.html">Windows Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Install%20in%20DAL%20Win.html">DAL Windows Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Install%20in%20Linux.html">Linux Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Install%20in%20MacOS.html">MacOS Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../USB%20with%20UEFI%20Shell.html">Building a Bootable USB drive with UEFI Shell (x64)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Using-CHIPSEC-with-Kali-Linux.html">Creating the Kali Linux Live USB</a></li>
</ul>
<p class="caption"><span class="caption-text">Using CHIPSEC</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Running-Chipsec.html">Running CHIPSEC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Interpreting-Results.html">Interpreting results</a></li>
</ul>
<p class="caption"><span class="caption-text">Architecture and Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Architecture-Overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vulnerabilities-and-CHIPSEC-Modules.html">CHIPSEC Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developing.html">Writing Your Own Modules</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CHIPSEC  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">chipsec.hal.uefi_platform</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Last updated on Jun 25, 2021.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>